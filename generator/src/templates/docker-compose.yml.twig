version: "3.5"

{% include "application-volumes.yml.twig" with {
    _mountMode: _mountMode
} %}

services:
{% if _blackfire['enabled'] %}
  blackfire:
    image: blackfire/blackfire
    environment:
      # Exposes BLACKFIRE_SERVER_* environment variables from the host
      - BLACKFIRE_SERVER_ID
      - BLACKFIRE_SERVER_TOKEN
      - BLACKFIRE_CLIENT_ID
      - BLACKFIRE_CLIENT_TOKEN
    networks:
      - services
      - public
{% endif %}

  frontend:
    image: nginx:alpine
    ports:
{% for port in _ports %}
      - "{{ port }}:{{ port }}"
{% endfor %}
    networks:
      services:
        aliases:
{% for host in _hosts %}
{% if host != 'localhost' %}
          - {{ host }}
{% endif %}
{% endfor %}
      public:
    depends_on:
{% for group in groups %}
{% for applicationName, applicationData in group['applications'] %}
{% if applicationData['application'] != 'static' %}
      - {{ applicationName | lower }}
{% endif %}
{% endfor %}
{% endfor %}
{% for serviceName, serviceData in services %}
      - {{ serviceName }}
{% endfor %}
    environment:
      DHPARAM_BITS: 1024
      DHPARAM_GENERATION: "false"
      ALLOWED_IP: "127.0.0.1"
    volumes:
      - ./${DEPLOYMENT_PATH}/context/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./${DEPLOYMENT_PATH}/context/nginx/conf.d/front-end.default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./${DEPLOYMENT_PATH}/context/nginx/stream.d/front-end.default.conf:/etc/nginx/stream.d/default.conf:ro
      - ./${DEPLOYMENT_PATH}/context/nginx/auth:/etc/nginx/auth:ro
      - ./${DEPLOYMENT_PATH}/context/nginx/ssl:/etc/nginx/ssl:ro
{% if _mountMode == 'baked' %}
      - assets:/data/public:ro
{% elseif _mountMode == 'native' %}
      - ./public:/data/public:ro
{% else %}
      - ${SPRYKER_DOCKER_PREFIX}_${SPRYKER_DOCKER_TAG}_data_sync:/data
{% endif %}

  rpc_server:
    image: nginx:alpine
    depends_on:
{% for group in groups %}
{% for applicationName, applicationData in group['applications'] %}
{% if applicationData['application'] == 'zed' %}
      - {{ applicationName | lower }}
{% endif %}
{% endfor %}
{% endfor %}
    networks:
      services:
        aliases:
{% for region in regions %}
{% for storeName, storeData in region['stores'] %}
          - rpc_server_{{ storeName | lower }}
{% endfor %}
{% endfor %}
      private:
    environment:
      DHPARAM_BITS: 1024
      DHPARAM_GENERATION: "false"
      ALLOWED_IP: "127.0.0.1"
    volumes:
      - ./${DEPLOYMENT_PATH}/context/nginx/conf.d/zed-rpc.default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./${DEPLOYMENT_PATH}/context/nginx/vhost.d:/etc/nginx/vhost.d:ro

{% for group in groups %}
{% for applicationName, applicationData in group['applications'] %}
{% if applicationData['application'] != 'static' %}

{% include "application/" ~ (applicationData['application'] | lower) ~ ".yml.twig" with {
    applicationName: applicationName,
    applicationData: applicationData,
    regionName: group['region'],
    project: _context
} %}
{% endif %}
{% endfor %}
{% endfor %}
{% for serviceName, serviceData in services %}
    {% set engine = serviceData['engine'] | lower %}
    {% set version = serviceData['version'] | default('default') %}

{% include "service/" ~ engine ~ "/" ~ version ~ "/" ~  engine ~ ".yml.twig" with { serviceName: serviceName, serviceData: serviceData, engine: engine, version: version } only %}
{% endfor %}

volumes:
{% for service, serviceData in services %}
  {{ service }}-{{ serviceData['engine'] }}-data:
    external: false
{% endfor %}

  logs:
    external: false
{% if _mountMode == 'baked' %}
  assets:
    external: true
    name: "${COMPOSE_PROJECT_NAME}_assets"
{% elseif _mountMode != 'native' %}
  {{ namespace }}_{{ tag }}_data_sync:
    external: true
{% endif %}

networks:
  public:
  services:
  private:
